# Segurança e CORS
Header always set Access-Control-Allow-Origin "*"
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-XSS-Protection "1; mode=block"

# Configurações do diretório
Options -Indexes +MultiViews +FollowSymlinks
ErrorDocument 401 "Unauthorized access"
ErrorDocument 403 "Forbidden"
ErrorDocument 404 "Not Found"

# Rewrite Rules
RewriteEngine On
RewriteBase /
IndexIgnore *

# Redirecionar para HTTPS (descomente se usar SSL)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Router principal
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ /index.php/$1 [NC,L,QSA]

# Cache para recursos estáticos
<filesMatch "\.(ico|pdf|flv|jpg|svg|jpeg|webp|png|gif|js|css|swf|woff|woff2|ttf|eot|otf|avif)$">
    Header set Cache-Control "max-age=31536000, public, immutable"
</filesMatch>

# Variáveis de ambiente
SetEnv SEO_SUPPORT 1

# Compressão GZIP/DEFLATE para PHP 8.3+
<IfModule mod_deflate.c>
  # Comprimir HTML, CSS, JavaScript, JSON, XML e fontes
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/json
  AddOutputFilterByType DEFLATE application/ld+json
  AddOutputFilterByType DEFLATE application/rss+xml
  AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
  AddOutputFilterByType DEFLATE application/x-font
  AddOutputFilterByType DEFLATE application/x-font-opentype
  AddOutputFilterByType DEFLATE application/x-font-otf
  AddOutputFilterByType DEFLATE application/x-font-truetype
  AddOutputFilterByType DEFLATE application/x-font-ttf
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/xhtml+xml
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE font/opentype
  AddOutputFilterByType DEFLATE font/otf
  AddOutputFilterByType DEFLATE font/ttf
  AddOutputFilterByType DEFLATE font/woff
  AddOutputFilterByType DEFLATE font/woff2
  AddOutputFilterByType DEFLATE image/svg+xml
  AddOutputFilterByType DEFLATE image/x-icon
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE text/xml
  
  # Header Vary para cache adequado
  Header append Vary Accept-Encoding
</IfModule>

<IfModule mod_headers.c>
    Header unset ETag
    Header append Vary Accept env=REDIRECT_accept

    RewriteCond "%{HTTP:Accept-encoding}" "gzip"
    RewriteCond "%{REQUEST_FILENAME}\.gz" -s
    RewriteRule "^(.*)\.css" "$1\.css\.gz" [QSA]

    RewriteCond "%{HTTP:Accept-encoding}" "gzip"
    RewriteCond "%{REQUEST_FILENAME}\.gz" -s
    RewriteRule "^(.*)\.js" "$1\.js\.gz" [QSA]

    #RewriteCond "%{HTTP:Accept-encoding}" "gzip"
    #RewriteCond "%{REQUEST_FILENAME}\.gz" -s
    #RewriteRule "^(.*)\.jpg" "$1\.jpg\.gz" [QSA]


    RewriteRule "\.css\.gz$" "-" [T=text/css,E=no-gzip:1]
    RewriteRule "\.js\.gz$" "-" [T=text/javascript,E=no-gzip:1]
    RewriteRule "\.jpg\.gz$" "-" [T=image/jpg,E=no-gzip:1]
    RewriteRule "\.png\.gz$" "-" [T=image/png,E=no-gzip:1]
    <FilesMatch "(\.js\.gz|\.css\.gz)$">
     Header append Content-Encoding gzip

      Header append Vary Accept-Encoding
    </FilesMatch>
</IfModule>
AddOutputFilterByType DEFLATE application/x-javascript text/css text/html text/xml

#Força o IE a sempre carregar utilizando a última versão disponível
<IfModule mod_headers.c>
  Header set X-UA-Compatible "IE=Edge"
  <FilesMatch "\.(css|js|gif|png|jpeg|pdf|xml|oga|ogg|m4a|ogv|mp4|m4v|webm|svg|svgz|eot|ttf|otf|woff|woff2|ico|webp|appcache|manifest|htc|crx|oex|xpi|safariextz|vcf)$" >
    Header unset X-UA-Compatible
  </FilesMatch>
</IfModule>
# Tipos MIME modernos
AddType image/webp .webp
AddType image/avif .avif
AddType font/woff2 .woff2
AddType application/manifest+json .webmanifest

# Desabilitar ETag para melhor performance
FileETag None

# Expiração de Cache otimizada para PHP 8.3+
<IfModule mod_expires.c>
 ExpiresActive On
 ExpiresDefault "access plus 0 seconds"
 
 # Manifests e HTML
 ExpiresByType text/cache-manifest "access plus 0 seconds"
 ExpiresByType text/html "access plus 0 seconds"
 ExpiresByType application/manifest+json "access plus 1 week"
 
 # Data (JSON, XML)
 ExpiresByType text/xml "access plus 0 seconds"
 ExpiresByType application/xml "access plus 0 seconds"
 ExpiresByType application/json "access plus 0 seconds"
 ExpiresByType application/ld+json "access plus 0 seconds"
 
 # Feeds
 ExpiresByType application/rss+xml "access plus 1 hour"
 ExpiresByType application/atom+xml "access plus 1 hour"
 
 # Favicon e ícones
 ExpiresByType image/x-icon "access plus 1 year"
 
 # Imagens (formatos modernos)
 ExpiresByType image/gif "access plus 1 year"
 ExpiresByType image/png "access plus 1 year"
 ExpiresByType image/jpg "access plus 1 year"
 ExpiresByType image/jpeg "access plus 1 year"
 ExpiresByType image/webp "access plus 1 year"
 ExpiresByType image/avif "access plus 1 year"
 ExpiresByType image/svg+xml "access plus 1 year"
 
 # Vídeo e Áudio
 ExpiresByType video/ogg "access plus 1 year"
 ExpiresByType audio/ogg "access plus 1 year"
 ExpiresByType video/mp4 "access plus 1 year"
 ExpiresByType video/webm "access plus 1 year"
 
 # Webfonts
 ExpiresByType font/ttf "access plus 1 year"
 ExpiresByType font/otf "access plus 1 year"
 ExpiresByType font/woff "access plus 1 year"
 ExpiresByType font/woff2 "access plus 1 year"
 ExpiresByType application/x-font-ttf "access plus 1 year"
 ExpiresByType application/x-font-woff "access plus 1 year"
 ExpiresByType application/font-woff2 "access plus 1 year"
 ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
 
 # CSS e JavaScript
 ExpiresByType text/css "access plus 1 year"
 ExpiresByType application/javascript "access plus 1 year"
 ExpiresByType text/javascript "access plus 1 year"
</IfModule>

# Cache específico para CSS/JS com versionamento
<filesMatch "\.(css|js)$">
 Header set Cache-Control "max-age=31536000, public, immutable"
</filesMatch>