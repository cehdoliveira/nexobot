services:
  # ============================================
  # üì¶ PHP Application Server (Site)
  # ============================================
  app:
    image: <SUA_IMAGEM_CUSTOMIZADA>  # Imagem customizada com extens√µes pr√©-instaladas
    deploy:
      replicas: 2
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
      labels:
        # Traefik: Roteamento para Site
        - "traefik.enable=true"
        - "traefik.docker.network=<SUA_REDE_INTERNET_DO_PORTAINER>"
        
        # Site (<SEU_DOMINIO>)
        - "traefik.http.routers.<NOME_APP>-site.rule=Host(`<SEU_DOMINIO>`)"
        - "traefik.http.routers.<NOME_APP>-site.entrypoints=websecure"
        - "traefik.http.routers.<NOME_APP>-site.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.<NOME_APP>-site.service=<NOME_APP>-site"
        - "traefik.http.services.<NOME_APP>-site.loadbalancer.server.port=80"

    volumes:
      # Arquivos do Site
      - /opt/<NOME_APP>/site:/var/www/site:rw
      
      # Logs compartilhados
      - /opt/<NOME_APP>/logs/apache2:/var/log/apache2:rw

      # Monta a raiz do projeto em /git para permitir git pull completo
      - /opt/<NOME_APP>:/git:rw
    
    networks:
      - <SUA_REDE_INTERNET_DO_PORTAINER>  # Conecta √† rede para acessar outros servi√ßos se necess√°rio
    
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # ========================================
  #  Redis Cache
  # ========================================
  redis:
    image: redis:7-alpine
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    
    volumes:
      - redis-data:/data
    
    networks:
      - <SUA_REDE_INTERNET_DO_PORTAINER>  # Conecta √† rede para acessar outros servi√ßos se necess√°rio
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # ========================================
  # üë∑ Email Worker Site (Kafka Consumer)
  # ========================================
  email_worker_site:
    image: <SUA_IMAGEM_CUSTOMIZADA>  # Mesma imagem customizada
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    
    volumes:
      # Worker precisa acessar o c√≥digo do site
      - /opt/<NOME_APP>/site:/var/www/site:ro
    
    networks:
      - <SUA_REDE_INTERNET_DO_PORTAINER>  # Conecta √† rede para acessar outros servi√ßos se necess√°rio
    
    # Sobrescrever CMD padr√£o (apache) para rodar worker
    entrypoint: []
    command: ["php", "/var/www/site/cgi-bin/kafka_email_worker.php"]
    
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f kafka_email_worker.php || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
  
# ========================================
# üåê Networks
# ========================================
networks:  
  <SUA_REDE_INTERNET_DO_PORTAINER>:
    external: true

# ========================================
# üíæ Volumes
# ========================================
volumes:
  redis-data:
    driver: local